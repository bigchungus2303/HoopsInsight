# NBA Player Performance Predictor â€“ Project Specification & Execution Plan

## ðŸŽ¯ Purpose
A data-driven application that fetches NBA player statistics and models **regression-to-mean** behavior using both descriptive statistics and probabilistic analysis.  
The goal is to estimate the **cool-off probability** (inverse-likelihood of repeating high performances) across points, assists, rebounds, and 3-pointers â€” adjusted for player career phase, seasonal normalization, and fatigue/load effects.

---

## ðŸ§± Core Functional Modules

### 1. Player Search
- Autocomplete search using `balldontlie.io` API  
- Display: **Name**, **Team**, **Position**, **Height**, **Weight**  
- On select:
  - Fetch season averages  
  - Fetch last 5 games  
  - Load career data for weighting model

### 2. Season Statistics
Displays per-game season metrics:
- **PPG**, **RPG**, **APG**, **FG%**, **3P%**, **FT%**, **MPG**, **Minutes Played**
- Includes z-score normalization against league averages

### 3. Player Comparison
- Dual-player comparison layout  
- Interactive bar charts for **PTS**, **REB**, **AST**, **FG%**, **3P%**  
- Overlay of inverse-likelihood â€œcool-offâ€ probability curves

### 4. Recent Game Performance
- Line chart for last 5 games showing **points**, **rebounds**, **assists**, and **minutes played**  
- Tooltips with detailed game stats  
- Dynamic updates on player/season change

### 5. Inverse-Frequency Probability Model

**Core Formula:**
\[
P_{inv}(x) = 1 - f(x), \quad f(x) = \frac{1}{N}\sum I[\text{stat}_i â‰¥ t]
\]

**Adjustments:**
1. **Career Phase Weighting**
   - Early â†’ rising trend (recent seasons weighted higher)  
   - Peak â†’ stable mean (balanced weighting)  
   - Late â†’ decline (stronger exponential decay)  
   \[
   w_i = e^{-Î» (T - t_i)}
   \]

2. **Seasonal Normalization (z-score)**
   \[
   z = \frac{x - Î¼_{season}}{Ïƒ_{season}}
   \]

3. **Dynamic Player Thresholds**
   \[
   \text{thresholds} = \{Î¼, Î¼+Ïƒ, Î¼+2Ïƒ, Î¼+3Ïƒ\}
   \]

4. **Fatigue / Load Curve**
   - Rolling 10-game mean vs long-term mean  
   - If current > mean +1Ïƒ â†’ regression likelihood â†‘

5. **Injury / Minutes-Played Filter**
   - Declining minutes = lower sustain probability

6. **Non-Stationarity Handling**
   - Recency weighting keeps responsiveness while retaining long-term variance

---

## ðŸ“Š Statistical Thresholds
| Category | Thresholds |
|-----------|-------------|
| Points | 10, 15, 20 |
| Rebounds | 4, 6, 8, 10 |
| Assists | 4, 6, 8, 10 |
| 3-Pointers | 2, 3, 5 |

Each threshold:
- Computes **frequency**, **inverse-likelihood**, and **weighted inverse-likelihood**
- Visualized in grouped bar charts per stat

---

## ðŸ“ˆ Visualization
1. **Frequency vs Inverse-Likelihood Bar Charts** â€“ For PTS, REB, AST, 3PM  
2. **Career-Adjusted Cool-Off Curve** â€“ Regression probability by player phase  
3. **Dual Comparison Dashboard** â€“ Side-by-side player view  
4. **Fatigue Curve** â€“ Rolling vs historical mean (minutes & output)

---

## âš™ï¸ Tech Stack
| Layer | Technology |
|--------|-------------|
| **Frontend** | React + TypeScript + TailwindCSS + Recharts |
| **Backend** | FastAPI or Flask |
| **Data Source** | `balldontlie.io` |
| **Computation Engine** | NumPy / Pandas |
| **Visualization (MVP)** | Streamlit |
| **Persistence** | SQLite (optional cache) |

---

## ðŸ§® Data Model

### Player
| Field | Type | Description |
|--------|------|-------------|
| id | int | Player ID |
| name | string | Full name |
| team | string | Team |
| position | string | Role |
| height / weight | string | Physical data |

### Season Stats
| Field | Type |
|--------|------|
| pts | float |
| reb | float |
| ast | float |
| fg_pct | float |
| fg3_pct | float |
| ft_pct | float |
| min | float |
| games_played | int |

### Game Record
| Field | Type |
|--------|------|
| date | string |
| pts, reb, ast, fg3m | float |
| min | float |
| season | int |

---

# ðŸ§­ Execution Plan

## Step 1: Repository Bootstrap
```bash
mkdir nba-stats-mvp && cd nba-stats-mvp
python -m venv .venv && source .venv/bin/activate  # Windows: .venv\Scripts\activate
echo "requests>=2.32.3\npandas>=2.2.2\nmatplotlib>=3.9.0" > requirements.txt
pip install -r requirements.txt
```

## Step 2: Data Layer
Create:
- `fetch_nba.py` â†’ API client with retry & pagination  
- `analyze.py` â†’ inverse-likelihood model  
- `data/` â†’ JSON/CSV storage

Example:
```bash
python fetch_nba.py --player "LeBron James" --season 2024 --last 5 --out json,csv
python analyze.py --file data/lebron_james_*.json --targets "pts:10,15,20;ast:5,8,10"
```

## Step 3: CLI Validation
- Check outputs  
- Validate JSON & CSV content  
- Tune Î± (recency weight) between 0.8â€“0.9

## Step 4: Streamlit / Web UI
- Streamlit MVP  
- Interactive stats & charts  
- Expand later into React + FastAPI

---

## ðŸ“‚ Directory Structure
```
nba-stats-mvp/
  .cursorrules
  README.md
  nba-stats.md
  requirements.txt
  fetch_nba.py
  analyze.py
  data/
  notebooks/
    exploration.ipynb
```

---

## ðŸ§  Modeling Rules
\[
\hat{p}_{\ge t} = \frac{1}{N}\sum I[x_i \ge t], \quad q_{\ge t} = 1 - \hat{p}_{\ge t}
\]
Weighted version:
\[
w_i = Î±^{N-i}, \quad \hat{p}^{(w)} = \sum w_i I[x_i \ge t], \quad q^{(w)} = 1 - \hat{p}^{(w)}
\]
Career-phase weighting:
\[
w_i = e^{-Î» (T - t_i)}, \quad Î»_{early} < Î»_{peak} < Î»_{late}
\]
Z-score normalization:
\[
z = \frac{x - Î¼_{season}}{Ïƒ_{season}}
\]

---

## âœ… Testing Checklist
- Player not found â†’ handled  
- Small N â†’ stable output  
- Î± = 1 â†’ unweighted results  
- Î± < 1 â†’ recent games emphasized  
- Output written to `_analysis.json`

---

## ðŸ§ª Notebook
`notebooks/exploration.ipynb`: visualize inverse vs frequency and validate trends.

---

## ðŸ—‚ Cursor Rule
```
Always read nba-stats.md before coding.
Document CLI flags, formulas, and assumptions.
Update when model logic or API data structure changes or Update documentation after major features
Frontend only starts after CLI validation.
```

---

## ðŸ§¾ Data Contract

### Input JSON
```json
{
  "player": { "id": 15, "first_name": "LeBron", "last_name": "James" },
  "season": 2024,
  "games": [
    { "date": "2024-03-12", "pts": 25, "reb": 7, "ast": 9, "fg3m": 2, "min": 34 }
  ]
}
```

### Output JSON
```json
{
  "player": "LeBron James",
  "season": 2024,
  "n_games": 5,
  "alpha": 0.85,
  "targets": { "pts": [10,15,20], "ast": [5,8,10] },
  "results": {
    "pts": [
      { "threshold": 10, "frequency": 0.8, "inverse": 0.2, "weighted_freq": 0.77, "weighted_inverse": 0.23 }
    ]
  }
}
```

---

## ðŸ§© Future Enhancements
- Bayesian smoothing for probabilities  
- Multi-season calibration with exponential decay  
- Team-level fatigue and back-to-back adjustments  
- Player similarity clustering (z-score vectors)  
- Next-game stat distribution simulation  

---

## ðŸ“Œ Backlog Priority
1. âœ… CLI fetch + analysis  
2. âœ… Weighted inverse model  
3. âœ… Streamlit charts  
4. âœ… Career-phase weighting  
5. âœ… Dynamic thresholds (Î¼ + nÏƒ)  
6. âœ… Fatigue/load curve  
7. âœ… Minutes/injury filter  
8. â³ React comparison dashboard

## ðŸ“ Implementation Updates (October 2025)

### Next Game Predictions Feature âœ¨
**New Section Added:**
- Header: "ðŸ”® Next Game Predictions"
- Displays success probability for each custom threshold
- Example: "â‰¥ 20 points: 65% (Confidence: High)"
- Uses `weighted_frequency` from inverse-frequency model
- Applies Bayesian smoothing for samples <10 games
- Shows confidence levels: High (â‰¥5 occurrences) or Low (<5 occurrences)
- Recency weighted with configurable Î± parameter (default 0.85)
- Expandable info guide explains probability calculations
- Configured via Advanced Settings thresholds

### API Data Structure Changes
**Minutes Field Format:**
- API returns minutes as **"MM:SS" string** (e.g., "34:08" = 34 minutes 8 seconds)
- Implemented `parse_minutes()` function to convert to decimal: `34:08 â†’ 34.13`
- Applied parsing in:
  - Display metrics (app.py)
  - Z-score calculations (statistics.py)
  - Chart plotting (plotly visualizations)

### Season Display Format
**NBA Convention Adopted:**
- Changed from single year ("2024") to full season format ("2024-2025")
- Updated in all selectors: main, favorites, comparison
- Season Statistics header shows full format
- Backend API still uses base year (2024-2025 â†’ API request with year=2024)

### Data Availability
**2024-2025 Season:**
- Confirmed data available from October 2024 through April 2025
- Request `per_page=100` to fetch complete season before sorting
- Recent games charts display 2025 dates correctly
- All numeric conversions use `pd.to_numeric()` and `safe_float()`

### Current Tech Stack
- âœ… **Frontend**: Streamlit (MVP complete)
- âœ… **Backend**: Direct API integration (no FastAPI/Flask layer)
- âœ… **Data Source**: balldontlie.io API v1
- âœ… **Computation**: NumPy, Pandas, SciPy
- âœ… **Visualization**: Plotly (express & graph_objects)
- âœ… **Persistence**: SQLite (caching + favorites)

### Implemented Formulas & Assumptions

**Inverse-Frequency Model:**
```
P_inv(x) = 1 - f(x)
f(x) = (1/N) * Î£ I[stat_i â‰¥ t]
```
- Applied with Bayesian smoothing (Î±=1, Î²=1) for samples <10 games
- Supports dynamic thresholds: {Î¼, Î¼+Ïƒ, Î¼+2Ïƒ, Î¼+3Ïƒ}

**Career Phase Weighting:**
```
w_i = e^(-Î»(T - t_i))
Î»_early = 0.02 (default)
Î»_peak = 0.05 (default)  
Î»_late = 0.08 (default)
```

**Z-Score Normalization:**
```
z = (x - Î¼_season) / Ïƒ_season
```
- Applied to: PTS, REB, AST, FG%, 3P%, FT%, MIN
- League averages calculated from season data

**Recency Weighting:**
```
Î± = 0.85 (default, configurable 0.5-1.0)
w_i = Î±^(N-i)
```

**Fatigue Analysis:**
- 10-game rolling average vs long-term mean
- Regression risk = (current - mean) / std_dev
- Minutes trend detection with linear regression  

---

## ðŸ§© End Objective
Deliver a statistically grounded NBA performance predictor that quantifies regression likelihood per player and visualizes trends interactively â€” establishing a foundation for future predictive and simulation-based analytics.
